# 🛡️ Гайд по безопасному использованию Cian Parser Bot

## ⚠️ Важно: Предотвращение блокировки IP

Сайт **Cian.ru** и другие площадки могут блокировать IP-адреса при подозрении в автоматизированном парсинге. Этот гайд поможет минимизировать риски и правильно использовать бота.

---

## 🔒 1. Как предотвратить блокировку

### 🕒 **Частота запросов**

**❌ НЕ ДЕЛАЙТЕ:**
- Запускать парсинг каждые несколько минут
- Делать массовые запросы подряд
- Использовать автоматические скрипты для частых обновлений

**✅ РЕКОМЕНДУЕТСЯ:**
- Максимум **2-3 запроса в день**
- Интервал между запросами минимум **2-3 часа**
- Использовать кнопку **"Update"** вместо **"Start"** для регулярных проверок

### 🌐 **Смена IP-адреса**

#### Способ 1: **Мобильный интернет**
```bash
# Переключайтесь между Wi-Fi и мобильным интернетом
# Мобильные операторы часто выдают динамические IP
```

#### Способ 2: **VPN сервисы**
```bash
# Рекомендуемые VPN с российскими серверами:
# - NordVPN
# - ExpressVPN  
# - ProtonVPN
# - Surfshark
```

#### Способ 3: **Прокси-серверы**
```python
# Можно добавить прокси в config.py
PROXIES = {
    'http': 'http://proxy-server:port',
    'https': 'https://proxy-server:port'
}
```

### 🤖 **Имитация человеческого поведения**

**Уже реализовано в боте:**
- ✅ Реалистичные User-Agent заголовки
- ✅ Правильные Referer и заголовки браузера
- ✅ Таймауты запросов (30 секунд)

**Дополнительно можно:**
- Добавить случайные задержки между запросами
- Ротацию User-Agent строк
- Случайное время запуска парсинга

---

## 🚨 2. Что делать если IP заблокировали

### 🔍 **Признаки блокировки:**

1. **Ошибки подключения:**
   ```
   ❌ Ошибка при обращении к Cian.ru: Connection timeout
   ❌ Ошибка запроса к API: 403 Forbidden
   ❌ Ошибка запроса к API: 429 Too Many Requests
   ```

2. **Странные ответы:**
   - Пустые результаты при наличии объявлений
   - Редирект на страницу капчи
   - Ответы с HTML вместо JSON

### 🛠️ **Немедленные действия:**

#### Шаг 1: **Остановить все запросы**
```bash
# Прекратите использование бота минимум на 24 часа
# НЕ пытайтесь "пробить" блокировку частыми запросами
```

#### Шаг 2: **Сменить IP-адрес**
```bash
# Способ 1: Перезагрузка роутера (если динамический IP)
sudo reboot

# Способ 2: Отключить/включить мобильный интернет
# Способ 3: Подключить VPN
# Способ 4: Использовать другую сеть (соседи, кафе, офис)
```

#### Шаг 3: **Проверить доступность**
```bash
# Проверьте доступ через браузер
open https://perm.cian.ru/rent/commercial/

# Или через curl
curl -I https://perm.cian.ru/
```

#### Шаг 4: **Тестовый запрос**
```bash
# После смены IP сделайте один тестовый запрос
cd telegram_bot
python3 test_modules.py
```

---

## 📋 3. Лучшие практики использования

### ⏰ **Режим работы**

#### 🚀 **Кнопка "Start"** - используйте редко:
- **Частота:** Максимум 1 раз в день
- **Когда:** При первом запуске или после долгого перерыва
- **Цель:** Получить полную картину рынка

#### 🔄 **Кнопка "Update"** - основной режим:
- **Частота:** 2-3 раза в день максимум
- **Интервал:** Минимум 3-4 часа между запросами
- **Цель:** Отслеживать новые объявления

### 📅 **Рекомендуемое расписание:**

```
🌅 Утро (09:00-11:00):
  └── Первая проверка Update

🌞 День (14:00-16:00):  
  └── Вторая проверка Update

🌙 Вечер (19:00-21:00):
  └── Финальная проверка Update

🛡️ Ночь (22:00-08:00):
  └── НЕ ИСПОЛЬЗОВАТЬ (дать IP отдохнуть)
```

### 🏢 **Рабочие дни vs Выходные:**

**Будни (Пн-Пт):**
- Более активный парсинг (2-3 раза в день)
- Больше новых объявлений

**Выходные (Сб-Вс):**
- Сократить до 1 раза в день
- Риск блокировки выше (меньше "шума" от реальных пользователей)

---

## 🔧 4. Технические улучшения

### 💾 **Добавление прокси поддержки**

Создайте файл `proxy_config.py`:
```python
# Список прокси серверов (добавьте свои)
PROXY_LIST = [
    "http://proxy1:port",
    "http://proxy2:port", 
    "http://proxy3:port"
]

# Ротация прокси
import random
def get_random_proxy():
    return random.choice(PROXY_LIST) if PROXY_LIST else None
```

### 🎲 **Добавление случайных задержек**

В файл `parser.py` добавить:
```python
import time
import random

# Перед запросом добавить:
delay = random.uniform(2, 5)  # 2-5 секунд
time.sleep(delay)
```

### 🔄 **Ротация User-Agent**

```python
USER_AGENTS = [
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36'
]
```

---

## 🚨 5. Экстренные сценарии

### 📖 **Сценарий 1: Постоянная блокировка**

1. **Pause 72 часа** - полный перерыв
2. **Смените все:**
   - IP-адрес (VPN/прокси)
   - User-Agent строки
   - Расписание запросов
3. **Используйте только Update** - никаких Start
4. **Максимум 1 запрос в день**

### 📖 **Сценарий 2: Региональная блокировка**

```python
# Смените регион в config.py
'region': {
    'type': 'terms',
    'value': [4588],  # Екатеринбург вместо Перми (4927)
}
```

### 📖 **Сценарий 3: API недоступен**

1. **Переход на веб-парсинг** (более рискованно)
2. **Использование альтернативных источников:**
   - avito.ru
   - youla.ru
   - realty.yandex.ru

---

## ⚖️ 6. Юридические аспекты

### 📜 **Что можно:**
- ✅ Парсинг публичной информации для личного использования
- ✅ Анализ рыночных данных
- ✅ Мониторинг цен

### 🚫 **Что нельзя:**
- ❌ Коммерческое использование данных без разрешения
- ❌ Перепродажа информации
- ❌ Нарушение условий использования сайта
- ❌ Создание конкурирующих сервисов

### 📋 **Рекомендации:**
1. Ознакомьтесь с `robots.txt` сайта
2. Соблюдайте разумные лимиты запросов
3. Не создавайте чрезмерную нагрузку на сервера

---

## 📊 7. Мониторинг и логирование

### 📈 **Отслеживание статуса:**

Создайте файл `monitor.py`:
```python
import logging
from datetime import datetime

# Логирование всех запросов
logging.basicConfig(
    filename='parser_activity.log',
    level=logging.INFO,
    format='%(asctime)s - %(message)s'
)

def log_request(ip, status, offers_count):
    logging.info(f"IP: {ip}, Status: {status}, Offers: {offers_count}")
```

### 📋 **Чек-лист перед каждым запуском:**

- [ ] Прошло более 3 часов с последнего запроса?
- [ ] Использую Update вместо Start?
- [ ] Проверил доступность сайта в браузере?
- [ ] IP не менялся принудительно недавно?
- [ ] Нет активного VPN конфликта?

---

## 🎯 8. Резюме: Золотые правила

### 🥇 **Топ-5 правил безопасности:**

1. **🕒 Интервалы:** Минимум 3 часа между запросами
2. **🔄 Update > Start:** Используйте Update для регулярных проверок  
3. **📅 Режим:** Максимум 2-3 запроса в день
4. **🌐 Ротация:** Меняйте IP при первых признаках блокировки
5. **⏸️ Пауза:** При блокировке - перерыв минимум 24 часа

### 🎨 **Идеальный сценарий использования:**

```
День 1: Start (получить базу)
День 2-7: Update каждые 4-6 часов
День 8: Start (обновить базу)
...и так далее
```

---

## 📞 Контакты и поддержка

При возникновении проблем:
1. Проверьте логи бота
2. Следуйте этому гайду
3. Сделайте перерыв и попробуйте позже

**Помните:** Лучше получать данные медленно и стабильно, чем быстро и с риском блокировки! 🛡️ 